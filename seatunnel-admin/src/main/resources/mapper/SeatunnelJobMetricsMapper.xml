<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.apache.seatunnel.admin.dao.SeatunnelJobMetricsMapper">

    <sql id="BucketExpr">
        CASE #{granularity}
        WHEN 'MINUTE' THEN DATE_FORMAT(update_time, '%Y-%m-%d %H:%i')
        WHEN 'HOUR'   THEN DATE_FORMAT(update_time, '%Y-%m-%d %H:00')
        WHEN 'DAY'    THEN DATE_FORMAT(update_time, '%Y-%m-%d')
        ELSE DATE_FORMAT(update_time, '%Y-%m-%d %H:%i')
        END
    </sql>

    <select id="selectOverviewSummary" resultType="map">
        SELECT COALESCE(SUM(t.inc_records), 0) AS totalRecords,
               COALESCE(SUM(t.inc_bytes), 0)   AS totalBytes,
               COALESCE(COUNT(1), 0)           AS totalTasks
        FROM (
                 SELECT job_instance_id,
                        (MAX(write_row_count) - MIN(write_row_count)) AS inc_records,
                        (MAX(write_bytes) - MIN(write_bytes))         AS inc_bytes
                 FROM t_seatunnel_job_metrics
                 WHERE update_time &gt;= #{startTime}
                   AND update_time &lt;= #{endTime}
                 GROUP BY job_instance_id
             ) t
    </select>

    <select id="selectRecordsTrend" resultType="map">
        SELECT
        x.bucket AS date,
        COALESCE(SUM(x.inc_records), 0) AS value
        FROM (
        SELECT
        <include refid="BucketExpr"/>
        AS bucket,
        job_instance_id,
        SUM(read_row_count) AS inc_records
        FROM t_seatunnel_job_metrics
        WHERE update_time &gt;= #{startTime}
        AND update_time &lt;= #{endTime}
        GROUP BY bucket, job_instance_id
        ) x
        GROUP BY x.bucket
        ORDER BY x.bucket ASC
    </select>

    <select id="selectBytesTrend" resultType="map">
        SELECT
        x.bucket AS date,
        COALESCE(SUM(x.inc_bytes), 0) AS value
        FROM (
        SELECT
        <include refid="BucketExpr"/>
        AS bucket,
        job_instance_id,
        SUM(read_bytes) AS inc_bytes
        FROM t_seatunnel_job_metrics
        WHERE update_time &gt;= #{startTime}
        AND update_time &lt;= #{endTime}
        GROUP BY bucket, job_instance_id
        ) x
        GROUP BY x.bucket
        ORDER BY x.bucket ASC
    </select>

    <select id="selectRecordsSpeedTrend" resultType="map">
        SELECT
        <include refid="BucketExpr"/>
        AS date,
        CAST(AVG(write_qps) AS SIGNED) AS value
        FROM t_seatunnel_job_metrics
        WHERE update_time &gt;= #{startTime}
        AND update_time &lt;= #{endTime}
        GROUP BY date
        ORDER BY date ASC
    </select>

    <select id="selectBytesSpeedTrend" resultType="map">
        SELECT
        <include refid="BucketExpr"/>
        AS date,
        CAST(AVG(write_bps) AS SIGNED) AS value
        FROM t_seatunnel_job_metrics
        WHERE update_time &gt;= #{startTime}
        AND update_time &lt;= #{endTime}
        GROUP BY date
        ORDER BY date ASC
    </select>


</mapper>